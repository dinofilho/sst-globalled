import React, { useEffect, useMemo, useState } from "react";

type Company = {
  id: string;
  name: string;
  cnpj: string;
  createdAt: string;
};

type Employee = {
  id: string;
  companyId: string;
  name: string;
  cpf: string;
  createdAt: string;
};

type Exam = {
  id: string;
  companyId: string;
  employeeId: string;
  kind: "ASO_ADMISSIONAL" | "ASO_PERIODICO" | "ASO_DEMISSIONAL" | "ASO_RETORNO" | "ASO_MUDANCA_FUNCAO" | "OUTRO";
  examDate: string;   // YYYY-MM-DD
  expiryDate: string; // YYYY-MM-DD
  clinic: string;
  doctor: string;
  result: "APTO" | "INAPTO" | "PENDENTE";
  notes: string;
  createdAt: string;
};

const COMPANIES_KEY = "sst_globalled_companies_v1";
const EMPLOYEES_KEY = "sst_globalled_employees_v1";
const EXAMS_KEY = "sst_globalled_exams_v1";

function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function safeLoad<T>(key: string, fallback: T): T {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}
function safeSave(key: string, value: any) {
  localStorage.setItem(key, JSON.stringify(value));
}

function labelKind(k: Exam["kind"]) {
  switch (k) {
    case "ASO_ADMISSIONAL": return "ASO Admissional";
    case "ASO_PERIODICO": return "ASO Periódico";
    case "ASO_DEMISSIONAL": return "ASO Demissional";
    case "ASO_RETORNO": return "ASO Retorno ao Trabalho";
    case "ASO_MUDANCA_FUNCAO": return "ASO Mudança de Função";
    default: return "Outro";
  }
}

function daysTo(dateStr: string) {
  if (!dateStr) return null;
  const d = new Date(dateStr + "T00:00:00");
  const now = new Date();
  const diff = Math.ceil((d.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
  return diff;
}

export default function Exams() {
  const [companies, setCompanies] = useState<Company[]>([]);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [items, setItems] = useState<Exam[]>([]);
  const [query, setQuery] = useState("");
  const [editingId, setEditingId] = useState<string | null>(null);

  const [form, setForm] = useState<Omit<Exam, "id" | "createdAt">>({
    companyId: "",
    employeeId: "",
    kind: "ASO_PERIODICO",
    examDate: "",
    expiryDate: "",
    clinic: "",
    doctor: "",
    result: "PENDENTE",
    notes: "",
  });

  useEffect(() => {
    const cs = safeLoad<Company[]>(COMPANIES_KEY, []);
    const es = safeLoad<Employee[]>(EMPLOYEES_KEY, []);
    const xs = safeLoad<Exam[]>(EXAMS_KEY, []);
    setCompanies(cs);
    setEmployees(es);
    setItems(xs);

    if (cs.length && !form.companyId) {
      const cid = cs[0].id;
      const firstEmp = es.find((e) => e.companyId === cid);
      setForm((p) => ({ ...p, companyId: cid, employeeId: firstEmp?.id || "" }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    safeSave(EXAMS_KEY, items);
  }, [items]);

  const employeesOfCompany = useMemo(() => {
    return employees.filter((e) => e.companyId === form.companyId);
  }, [employees, form.companyId]);

  useEffect(() => {
    // se trocar empresa e funcionário não existir nela, ajusta
    const list = employees.filter((e) => e.companyId === form.companyId);
    if (!list.length) {
      setForm((p) => ({ ...p, employeeId: "" }));
    } else if (form.employeeId && !list.some((e) => e.id === form.employeeId)) {
      setForm((p) => ({ ...p, employeeId: list[0].id }));
    } else if (!form.employeeId) {
      setForm((p) => ({ ...p, employeeId: list[0].id }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [form.companyId, employees]);

  function onChange<K extends keyof typeof form>(key: K, value: (typeof form)[K]) {
    setForm((prev) => ({ ...prev, [key]: value }));
  }

  function resetForm() {
    setEditingId(null);
    const cid = companies[0]?.id || "";
    const firstEmp = employees.find((e) => e.companyId === cid)?.id || "";
    setForm({
      companyId: cid,
      employeeId: firstEmp,
      kind: "ASO_PERIODICO",
      examDate: "",
      expiryDate: "",
      clinic: "",
      doctor: "",
      result: "PENDENTE",
      notes: "",
    });
  }

  function validate() {
    if (!companies.length) return "Cadastre pelo menos 1 empresa primeiro.";
    if (!employees.length) return "Cadastre pelo menos 1 funcionário primeiro.";
    if (!form.companyId) return "Selecione a empresa.";
    if (!form.employeeId) return "Selecione o funcionário.";
    if (!form.examDate) return "Informe a data do exame.";
    if (!form.expiryDate) return "Informe a data de vencimento.";
    return null;
  }

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return items;

    const companyMap = new Map(companies.map((c) => [c.id, c.name]));
    const empMap = new Map(employees.map((e) => [e.id, e.name]));

    return items.filter((x) => {
      const hay = `${companyMap.get(x.companyId) || ""} ${empMap.get(x.employeeId) || ""} ${labelKind(x.kind)} ${x.result} ${x.clinic} ${x.doctor}`.toLowerCase();
      return hay.includes(q);
    });
  }, [items, query, companies, employees]);

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    const err = validate();
    if (err) return alert(err);

    if (editingId) {
      setItems((prev) =>
        prev.map((x) => (x.id === editingId ? { ...x, ...form } : x))
      );
      resetForm();
      return;
    }

    const item: Exam = {
      id: uid(),
      createdAt: new Date().toISOString(),
      ...form,
    };

    setItems((prev) => [item, ...prev]);
    resetForm();
  }

  function editOne(x: Exam) {
    setEditingId(x.id);
    setForm({
      companyId: x.companyId,
      employeeId: x.employeeId,
      kind: x.kind,
      examDate: x.examDate,
      expiryDate: x.expiryDate,
      clinic: x.clinic,
      doctor: x.doctor,
      result: x.result,
      notes: x.notes,
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function removeOne(id: string) {
    if (!confirm("Excluir este exame?")) return;
    setItems((prev) => prev.filter((x) => x.id !== id));
    if (editingId === id) resetForm();
  }

  const companyName = (id: string) => companies.find((c) => c.id === id)?.name || "—";
  const empName = (id: string) => employees.find((e) => e.id === id)?.name || "—";

  return (
    <div style={page}>
      <div style={card}>
        <h1 style={title}>Exames / ASO</h1>
        <p style={subtitle}>Controle de vencimentos por funcionário.</p>

        {(!companies.length || !employees.length) ? (
          <div style={warn}>
            Para cadastrar exames você precisa ter <b>empresa</b> e <b>funcionário</b> cadastrados.
          </div>
        ) : null}

        <form onSubmit={handleSubmit} style={{ display: "grid", gap: 12, marginTop: 10 }}>
          <div style={grid2}>
            <label style={labelWrap}>
              <span style={labelText}>Empresa *</span>
              <select value={form.companyId} onChange={(e) => onChange("companyId", e.target.value)} style={input}>
                {companies.map((c) => (
                  <option key={c.id} value={c.id}>
                    {c.name}
                  </option>
                ))}
              </select>
            </label>

            <label style={labelWrap}>
              <span style={labelText}>Funcionário *</span>
              <select value={form.employeeId} onChange={(e) => onChange("employeeId", e.target.value)} style={input}>
                {employeesOfCompany.map((e) => (
                  <option key={e.id} value={e.id}>
                    {e.name} ({e.cpf})
                  </option>
                ))}
              </select>
            </label>
          </div>

          <div style={grid2}>
            <label style={labelWrap}>
              <span style={labelText}>Tipo *</span>
              <select value={form.kind} onChange={(e) => onChange("kind", e.target.value as any)} style={input}>
                <option value="ASO_ADMISSIONAL">ASO Admissional</option>
                <option value="ASO_PERIODICO">ASO Periódico</option>
                <option value="ASO_RETORNO">ASO Retorno ao Trabalho</option>
                <option value="ASO_MUDANCA_FUNCAO">ASO Mudança de Função</option>
                <option value="ASO_DEMISSIONAL">ASO Demissional</option>
                <option value="OUTRO">Outro</option>
              </select>
            </label>

            <label style={labelWrap}>
              <span style={labelText}>Resultado</span>
              <select value={form.result} onChange={(e) => onChange("result", e.target.value as any)} style={input}>
                <option value="PENDENTE">Pendente</option>
                <option value="APTO">Apto</option>
                <option value="INAPTO">Inapto</option>
              </select>
            </label>
          </div>

          <div style={grid2}>
            <Field label="Data do exame *" placeholder="YYYY-MM-DD" value={form.examDate} onChange={(v) => onChange("examDate", v)} />
            <Field label="Vencimento *" placeholder="YYYY-MM-DD" value={form.expiryDate} onChange={(v) => onChange("expiryDate", v)} />
          </div>

          <div style={grid2}>
            <Field label="Clínica" placeholder="Nome da clínica" value={form.clinic} onChange={(v) => onChange("clinic", v)} />
            <Field label="Médico" placeholder="Dr(a). ..." value={form.doctor} onChange={(v) => onChange("doctor", v)} />
          </div>

          <TextArea label="Observações" placeholder="Anotações, restrições, etc." value={form.notes} onChange={(v) => onChange("notes", v)} />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginTop: 4 }}>
            <button type="submit" style={editingId ? btnPrimaryAlt : btnPrimary}>
              {editingId ? "Salvar Alteração" : "Cadastrar Exame"}
            </button>
            <button type="button" onClick={resetForm} style={btn}>
              Limpar
            </button>
          </div>
        </form>
      </div>

      <div style={card}>
        <div style={{ display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap" }}>
          <h2 style={{ margin: 0 }}>Exames cadastrados</h2>
          <span style={pill}>{items.length}</span>
          <div style={{ flex: 1 }} />
          <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Buscar por funcionário, empresa..." style={search} />
        </div>

        <div style={{ marginTop: 14, display: "grid", gap: 10 }}>
          {filtered.length === 0 ? (
            <div style={empty}>Nenhum exame encontrado.</div>
          ) : (
            filtered.map((x) => {
              const d = daysTo(x.expiryDate);
              const badge =
                d == null ? "—" : d < 0 ? `Vencido (${Math.abs(d)}d)` : d === 0 ? "Vence hoje" : `Vence em ${d}d`;

              return (
                <div key={x.id} style={row}>
                  <div style={{ minWidth: 0 }}>
                    <div style={rowTitle}>{labelKind(x.kind)} • {x.result}</div>
                    <div style={rowSub}>
                      <b>Empresa:</b> {companyName(x.companyId)} • <b>Funcionário:</b> {empName(x.employeeId)}
                    </div>
                    <div style={rowSub}>
                      <b>Exame:</b> {x.examDate} • <b>Venc.:</b> {x.expiryDate} • <b>Status:</b> {badge}
                    </div>
                    {(x.clinic || x.doctor) ? (
                      <div style={rowSub}>
                        {x.clinic ? (<><b>Clínica:</b> {x.clinic} • </>) : null}
                        {x.doctor ? (<><b>Médico:</b> {x.doctor}</>) : null}
                      </div>
                    ) : null}
                    {x.notes ? <div style={rowNotes}>{x.notes}</div> : null}
                  </div>

                  <div style={{ display: "flex", gap: 8, flexShrink: 0 }}>
                    <button onClick={() => editOne(x)} style={btnSmall}>Editar</button>
                    <button onClick={() => removeOne(x.id)} style={btnSmallDanger}>Excluir</button>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

/* ===== componentes ===== */

function Field(props: { label: string; placeholder?: string; value: string; onChange: (v: string) => void }) {
  return (
    <label style={labelWrap}>
      <span style={labelText}>{props.label}</span>
      <input value={props.value} onChange={(e) => props.onChange(e.target.value)} placeholder={props.placeholder} style={input} />
    </label>
  );
}

function TextArea(props: { label: string; placeholder?: string; value: string; onChange: (v: string) => void }) {
  return (
    <label style={labelWrap}>
      <span style={labelText}>{props.label}</span>
      <textarea
        value={props.value}
        onChange={(e) => props.onChange(e.target.value)}
        placeholder={props.placeholder}
        style={{ ...input, minHeight: 90, resize: "vertical", paddingTop: 10 }}
      />
    </label>
  );
}

/* ===== estilos ===== */

const page: React.CSSProperties = {
  minHeight: "100vh",
  background: "#0b0b0b",
  color: "#fff",
  padding: 16,
  display: "grid",
  gap: 14,
  alignContent: "start",
};

const card: React.CSSProperties = {
  background: "#111",
  border: "1px solid #222",
  borderRadius: 12,
  padding: 16,
  boxShadow: "0 10px 30px rgba(0,0,0,.25)",
};

const title: React.CSSProperties = { margin: 0, fontSize: 22 };
const subtitle: React.CSSProperties = { marginTop: 6, opacity: 0.75 };

const warn: React.CSSProperties = {
  marginTop: 10,
  padding: 12,
  borderRadius: 10,
  border: "1px solid #3a2a2a",
  background: "#1a1010",
  opacity: 0.95,
  fontSize: 13,
};

const grid2: React.CSSProperties = {
  display: "grid",
  gap: 12,
  gridTemplateColumns: "repeat(auto-fit, minmax(210px, 1fr))",
};

const labelWrap: React.CSSProperties = { display: "grid", gap: 6 };
const labelText: React.CSSProperties = { fontSize: 12, opacity: 0.75 };

const input: React.CSSProperties = {
  width: "100%",
  padding: "12px 12px",
  borderRadius: 10,
  border: "1px solid #2a2a2a",
  background: "#0c0c0c",
  color: "#fff",
  outline: "none",
};

const btnBase: React.CSSProperties = {
  padding: "12px 14px",
  borderRadius: 10,
  border: "1px solid #2a2a2a",
  background: "#151515",
  color: "#fff",
  fontWeight: 600,
};

const btn: React.CSSProperties = { ...btnBase };
const btnPrimary: React.CSSProperties = { ...btnBase, background: "#0a7a33", border: "none" };
const btnPrimaryAlt: React.CSSProperties = { ...btnBase, background: "#0a6a7a", border: "none" };

const search: React.CSSProperties = { ...input, maxWidth: 320, padding: "10px 12px" };

const pill: React.CSSProperties = {
  fontSize: 12,
  padding: "4px 10px",
  border: "1px solid #2a2a2a",
  borderRadius: 999,
  opacity: 0.8,
};

const row: React.CSSProperties = {
  border: "1px solid #222",
  background: "#0c0c0c",
  borderRadius: 12,
  padding: 14,
  display: "flex",
  gap: 12,
  alignItems: "flex-start",
  justifyContent: "space-between",
};

const rowTitle: React.CSSProperties = { fontWeight: 800, marginBottom: 4 };
const rowSub: React.CSSProperties = { fontSize: 12, opacity: 0.8, lineHeight: 1.5 };
const rowNotes: React.CSSProperties = {
  marginTop: 8,
  fontSize: 12,
  opacity: 0.75,
  borderTop: "1px dashed #222",
  paddingTop: 8,
};

const empty: React.CSSProperties = {
  padding: 14,
  borderRadius: 12,
  border: "1px dashed #333",
  opacity: 0.7,
};

const btnSmall: React.CSSProperties = {
  padding: "10px 12px",
  borderRadius: 10,
  border: "1px solid #2a2a2a",
  background: "#151515",
  color: "#fff",
  fontWeight: 700,
};

const btnSmallDanger: React.CSSProperties = {
  ...btnSmall,
  background: "#2a0c0c",
  border: "1px solid #4a1b1b",
};